---
- name: Creating the server_side Directory for the installation
  file: 
    path: "{{ base_dir }}/cqube/dashboard/server_side"
    owner: "{{ system_user_name }}"
    group: "{{ system_user_name }}"
    recurse: yes
    state: directory
  tags: [ install, update ]

- name: copying server-side script
  copy:
    src: "../../development/server_api/"
    dest: "{{base_dir}}/cqube/dashboard/server_side"
  tags: [ install, update ] 

- name: NodeJS dependencies install
  npm:
    path: "{{base_dir}}/cqube/dashboard/server_side"
  tags: [ install, update ]

- name: Creating environmental variables
  file:
    path: "{{base_dir}}/cqube/dashboard/server_side/.env"
    state: touch
    mode: u+rw,g+rw,o+rw
  tags: [ install, update ]

- name: Loading required data inside .env file when storage type is s3
  blockinfile:
    path: "{{base_dir}}/cqube/dashboard/server_side/.env"
    block: |
      STORAGE_SERVICE = "AWS_S3"
      ACCESS_KEY_ID = "{{ s3_access_key }}"
      SECRET_ACCESS_KEY  = "{{ s3_secret_key }}"
      OUTPUT_BUCKET = "{{ s3_output_bucket }}"
      INPUT_BUCKET = "{{ s3_input_bucket }}"
  when: storage_type == "s3"
  tags: [ install, update ]

- name: Loading required data inside .env file when storage type is azure
  blockinfile:
    path: "{{base_dir}}/cqube/dashboard/server_side/.env"
    block: |
      STORAGE_SERVICE = "AZURE_DATA_LAKE"
      AZURE_STORAGE_CONN_STR = "{{ azure_storage_connection_string }}"
      OUTPUT_CONTAINER = "{{ azure_output_container }}"
      INPUT_CONTAINER = "{{ azure_input_container }}"
  when: storage_type == "azure"
  tags: [ install, update ]

